name: Build and Release

on:
  # Disabled due to OpenCV compilation issues
  # Use Homebrew formula instead: Formula/snapshell.rb
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: "1.21"

      - name: Install OpenCV dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libopencv-dev libopencv-contrib-dev pkg-config

      - name: Build Linux AMD64
        env:
          CGO_ENABLED: 1
          GOOS: linux
          GOARCH: amd64
        run: |
          go build -ldflags="-s -w" -o snapshell-linux-amd64 cmd/main.go

      - name: Upload Linux artifact
        uses: actions/upload-artifact@v4
        with:
          name: snapshell-linux-amd64
          path: snapshell-linux-amd64

  release:
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          pattern: snapshell-*
          merge-multiple: true

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            artifacts/snapshell-*
          body: |
            # SnapShell Release

            ## Quick Install (Linux/macOS)

            ```bash
            curl -sSL https://raw.githubusercontent.com/saswatsam786/snapshell/main/install.sh | bash
            ```

            ## Manual Download

            - **Linux**: `snapshell-linux-amd64`

            ## Usage

            ```bash
            # Make executable 
            chmod +x snapshell-linux-amd64

            # Start video session (offerer)
            ./snapshell-linux-amd64 -signaled-o --room demo123 --server https://snapshell.onrender.com

            # Join video session (answerer) 
            ./snapshell-linux-amd64 -signaled-a --room demo123 --server https://snapshell.onrender.com
            ```

            ## About

            SnapShell converts live webcam video to ASCII art in real-time and shares it through WebRTC peer-to-peer connections. Perfect for terminal-based video sharing!
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
